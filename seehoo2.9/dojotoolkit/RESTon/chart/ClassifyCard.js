define(["dojo/_base/declare","../gfx/Axis","dojox/gfx","dojox/gfx/Moveable","../gfx/Fan"],function(r,t,a,i,e){var s=148;var o=126;var c=gShiftX=gShiftY=(s-o)/2;var h=15;var n=10;var v=[0,127,0];var f=[255,0,127,.5];var u=[150,150,150,.98];function g(r){var t=Math.sqrt(r);var a=Math.ceil(t);var i=[];for(var e=0;e<a;e++)i[e]=0;while(r>=a){for(var e=0;e<a;e++)i[e]++;r-=a}if(r>0){if(r%2==0){for(var e=0;e<parseInt(a/2);e++){i[e]++;i[a-e-1]++;r-=2;if(r<1)break}}else{var s=a-r;var o=parseInt(s/2);var c=r;for(var e=o;e<=o+c;e++){i[e]++;r--;if(r<1)break}}}return i}function l(r,t){var a=g(t);var i=r/(a.length+1);var e=i*2/5;var s=[];for(var o=0;o<a.length;o++){var c=(o+1)*i;var h=a[o];var n=r/(h+1);var v=[];s.push(v);for(var f=0;f<h;f++){var u=n*(f+1);v.push({cx:u,cy:c,r:e,stepX:n/2,stepY:i/2})}}return s}function d(r,t){var a="";a+=" M"+r+",0";a+=" L0,0";var i=" L"+r+",0";for(var e=0;e<t.length;e++){var s=t[e];var o=s[0];a+=" L0,"+o.cy;for(var c=0;c<s.length;c++){o=s[c];a+=" L"+(o.cx-o.r)+","+o.cy;a+=" A"+o.r+","+o.r+",180,0,1,"+(o.cx+o.r)+","+o.cy}a+=" L"+r+","+o.cy;a+=i;i=" L"+r+","+o.cy;a+=" M"+r+","+o.cy;for(var c=s.length-1;c>=0;c--){o=s[c];a+=" L"+(o.cx+o.r)+","+o.cy;a+=" A"+o.r+","+o.r+",180,0,1,"+(o.cx-o.r)+","+o.cy}a+=" L0,"+o.cy}a+=" L0,"+r;a+=" L"+r+","+r;a+=i;return a}var m=r(null,{constructor:function(r,t,a){this.surface=r;this.match=a;this.group=r.createGroup();var i=dojo.baseUrl+"../wiki/chart/images/match.png";for(var e in a.items){var s=this.match.items[e];if(!s.match){i=dojo.baseUrl+"../wiki/chart/images/unmatch.png";break}}var o=this.group.createImage({x:0,y:0,width:t.width,height:t.width,src:i});var c=t.path;var h=this.has={};for(var e in a.items){var s=this.match.items[e];var n=s.name;h[n]=s}for(var n in t.items){var v=t.items[n];if(!h[n]){c+=" M"+(v.cx-v.r+1)+","+v.cy;c+=" A"+(v.r-1)+","+(v.r-1)+",180,0,1,"+(v.cx+v.r-1)+","+v.cy;c+=" A"+(v.r-1)+","+(v.r-1)+",180,0,1,"+(v.cx-v.r+1)+","+v.cy}else if(!h[n].match){this.group.createCircle({cx:v.cx,cy:v.cy,r:v.r}).setFill(f)}}o.setClip({d:c+" E"})},moveTo:function(r,t){this.group.applyLeftTransform({dx:r,dy:t});this.g={x:r,y:t}},getG:function(){return this.g||{x:0,y:0}},showMe:function(){var r=this.surface.matchInfo;for(var t in r){r[t].innerHTML="";r[t].style.color="white"}for(var a in this.match.items){var i=this.match.items[a];var t=i.name;var e=r[t];e.innerHTML=i.reason||"";if(i.match)e.style.color="#00FF00";else e.style.color="#FF0000"}}});return r(null,{constructor:function(r,i){this.config=r;this.config.width=this.config.width||600;this.config.height=this.config.height||600;this.surface=a.createSurface(i,this.config.width,this.config.height);this.axis=new t({x:this.config.width/2,y:this.config.height/2});this._init()},_init:function(){this.group=this.surface.createGroup();var r=this.config.score;if(r)this.load(r())},load:function(r){var t=this;var a=r.customer.length;var e=0;var f={};for(var u=0;u<r.matches.length;u++){var g=r.matches[u];if(f[g.class]){f[g.class].push(g);continue}f[g.class]=[g];e++}var y=o;var x=l(y,a);var p={};var w=0;for(var u=0;u<x.length;u++){var L=x[u];for(var M=0;M<L.length;M++){var b=L[M];var T=r.customer[w++];p[T.name]={name:T.name,value:T.value,title:T.title,cx:b.cx,cy:b.cy,r:b.r,stepX:b.stepX,stepY:b.stepY}}}var j={width:y,margin:h,locs:x,path:d(y,x),items:p};var I=this.group.createGroup();I.createImage({x:0,y:0,width:s,height:s,src:dojo.baseUrl+"../wiki/chart/images/soleplate.png"});var S=I.createGroup();S.applyLeftTransform({dx:c,dy:c});for(var w in r.customer){var T=r.customer[w];var F=T.name;var L=p[F];S.createCircle(L).setFill(v)}this.custPoint={dx:this.axis.x-y/2+gShiftX,dy:this.axis.y-y/2+gShiftY};I.applyLeftTransform({dx:this.custPoint.dx-gShiftX,dy:this.custPoint.dy-gShiftY});var G=this.group.createGroup();var k=0;this.cubes=[];for(var X in f){var Y=k*y;var A=f[X];var P=0;for(var w in A){var C=P*y;var H=A[w];var U=new m(G,j,H);U.moveTo(C+P*h,Y+k*h);this.cubes.push(U);P++}k++}var _=new i(G);_.onMoveStart=function(r){var t=G.getTransform()||{dx:0,dy:0};this.current={x:t.dx,y:t.dy}};_.onMove=function(r,a){var i=this.current.x+=a.dx;var e=this.current.y+=a.dy;var s=G.getTransform()||{dx:0,dy:0};var o=t.custPoint;for(var c in t.cubes){var h=t.cubes[c];var v=h.getG();if(Math.abs(i+v.x-o.dx)<n&&Math.abs(e+v.y-o.dy)<n){G.setTransform({dx:o.dx-v.x,dy:o.dx-v.y});h.showMe();return}}this.onMoving(r,a);this.shape.applyLeftTransform({dx:i-s.dx,dy:e-s.dy});this.onMoved(r,a)};this.matchInfo={};G.matchInfo=this.matchInfo;var q=dojo.byId("content");for(var w in r.customer){var E=r.customer[w];var z=dojo.create("li",{innerHTML:E.title+" : "+E.value},q);var B=dojo.create("ul",{},z);this.matchInfo[E.name]=dojo.create("li",{},B)}}})});